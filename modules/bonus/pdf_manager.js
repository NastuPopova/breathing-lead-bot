// Файл: modules/bonus/pdf_manager.js
// PDF менеджер для дыхательного бота с дополнительными материалами

const { Markup } = require('telegraf');
const { products, messageTemplates } = require('../../data');
const { logWithTime } = require('../../utils');

class PDFBonusManager {
  constructor(bot) {
    this.bot = bot;
  }

  // Метод для перевода значений (если нужен)
  translateValue(value) {
    const translations = {
      stress: 'стресс',
      anxiety: 'тревожность',
      sleep: 'сон',
      energy: 'энергия',
      breathing: 'дыхание'
    };
    return translations[value] || value;
  }

  /**
   * ОБНОВЛЕННЫЙ метод showMoreMaterials - главный блок дополнительных материалов
   * Приведен в соответствие с реальными продуктами Анастасии
   */
  async showMoreMaterials(ctx) {
    const isChildFlow = ctx.session?.analysisResult?.analysisType === 'child';
    const primaryIssue = ctx.session?.analysisResult?.primaryIssue;
    const translatedIssue = this.translateValue(primaryIssue);

    // Используем шаблонные строки для большей читаемости
    let message = `
🎁 *ДОПОЛНИТЕЛЬНЫЕ МАТЕРИАЛЫ*

💡 *Вы получили персональный дыхательный гид!*
Это базовая техника. Полная система включает комплексные программы для глубокой трансформации.

🎁 *БЕСПЛАТНЫЕ БОНУСЫ:*
${isChildFlow ? `
• 📱 Ваш персональный HTML-гид (уже получили)
• 📄 PDF "Дыхательные игры для детей"
• 🎥 Видео "Как научить ребенка дышать" (3 мин)
• 📝 Чек-лист "Признаки стресса у детей"
` : `
• 📱 Ваш персональный HTML-гид (уже получили)
• 📄 PDF "Антистресс дыхание"
• 🎥 Видео "3 техники на каждый день" (5 мин)
• 📝 Чек-лист "Самодиагностика дыхания"
`}

🌬️ *КУРСЫ ДЫХАТЕЛЬНЫХ ПРАКТИК:*

🔥 *ХИТ ПРОДАЖ! СТАРТОВЫЙ КОМПЛЕКТ - 990₽*
*(вместо 2600₽ - скидка 62%)*

🎯 *Что получаете:*
• 📹 Видеоурок 40 минут с техникой К.П. Бутейко
• 📋 PDF-инструкция для самостоятельной практики
• 🎧 Аудиозапись для медитативного дыхания (15 минут)
• ⚡ Мгновенный доступ после оплаты

🎁 *БОНУСЫ В ПОДАРОК:*
• 🎥 Урок по замеру контрольной паузы
• 🧘 Аудиозапись для медитации

🧬 *Метод К.П. Бутейко:* научно доказанная эффективность при 100+ заболеваниях
⏰ *Результат:* улучшение самочувствия уже через 3-7 дней
💸 *Стоимость:* 990₽ (цена 1 похода к врачу!)

👉 *Идеально для тех, кто получил персональный гид и хочет углубиться в практики!*

👨‍⚕️ *ИНДИВИДУАЛЬНОЕ ЗАНЯТИЕ - 2000₽*
• Персональная диагностика дыхания
• Техники под вашу проблему
• 60 минут один на один с экспертом
• Запись консультации в подарок

📦 *ПАКЕТ 3 ЗАНЯТИЯ - 4500₽*
• 3 индивидуальные консультации
• Поэтапное освоение техник
• Контроль прогресса
• Поддержка между занятиями

🏆 *ПОЛНЫЙ КУРС ВИДЕОУРОКОВ - 14 999₽*
• Комплексная система дыхательных практик
• Пошаговое обучение от основ до продвинутого уровня
• Техники для разных ситуаций и проблем
• Пожизненный доступ к материалам
• Поддержка от сертифицированного инструктора

📈 *РЕЗУЛЬТАТ ЧЕРЕЗ 30 ДНЕЙ:*
• ✅ Повышение жизненной энергии и работоспособности
• ✅ Снижение уровня стресса и тревожности
• ✅ Улучшение качества сна
• ✅ Укрепление здоровья и иммунитета
• ✅ Улучшение работы дыхательной системы

🔥 *АКЦИЯ СЕГОДНЯ:*
💝 Консультация: БЕСПЛАТНО (диагностика дыхания)
📦 При покупке курса: PDF-гиды + аудиопрактики в подарок
🎁 Стартовый комплект: скидка 62% только сегодня (990₽ вместо 2600₽)

👩‍⚕️ *Записаться к Анастасии:* @breathing_opros_bot`;

    // Генерируем клавиатуру с бонусами
    const keyboard = [
      [Markup.button.callback('🔥 Хочу стартовый комплект за 990₽!', 'contact_request')],
      [Markup.button.callback('📞 Узнать о других программах', 'other_programs')],
      [
        isChildFlow
          ? Markup.button.callback('📄 PDF: Игры для детей', 'download_pdf_child_games')
          : Markup.button.callback('📄 PDF: Антистресс дыхание', 'download_pdf_adult_antistress')
      ],
      [Markup.button.url('💬 Заказать в основном боте', 'https://t.me/breathing_opros_bot')],
      [Markup.button.callback('🔙 К моей технике', 'back_to_results')]
    ];

    await ctx.editMessageText(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard(keyboard)
    });
  }

  /**
   * Новый метод для показа всех программ
   */
  async showAllPrograms(ctx) {
    let message = `
📚 *ВСЕ ПРОГРАММЫ ДЫХАТЕЛЬНЫХ ПРАКТИК*

Выберите программу, которая подходит вашим целям и возможностям:

🔥 *СТАРТОВЫЙ КОМПЛЕКТ - 990₽*
*Базовый набор для начинающих*

📦 *Что входит:*
• 🎥 Видеоурок длительностью 40 минут
• 📋 PDF-инструкция для самостоятельной практики
• ⚡ Мгновенный доступ после оплаты

🎁 *Бонусы:*
• 🎯 Урок по замеру контрольной паузы
• 🎧 Аудиозапись для медитативного дыхания (15 минут)

💰 *Стоимость:* 990₽ (вместо 2600₽)

─────────────────────────

👨‍⚕️ *ИНДИВИДУАЛЬНАЯ КОНСУЛЬТАЦИЯ - 2000₽*
*Для тех, кто хочет разобрать свою технику и получить персональные рекомендации*

📦 *Что входит:*
• 🕐 1 консультация 60 минут
• 🔍 Разбор вашей техники дыхания
• 🎯 Работа с вашими запросами
• 📹 Видеозапись консультаций для повторного просмотра

🎁 *Бонус:*
• 📊 Бесплатный краткий анализ вашего дыхания перед первой консультацией

💰 *Стоимость:* 2000₽ (вместо 2500₽)

─────────────────────────

🎯 *ПАКЕТ ИЗ 3-Х ИНДИВИДУАЛЬНЫХ ЗАНЯТИЙ - 4500₽*
*Для тех, кто хочет достичь устойчивых результатов и получить полноценную программу*

📦 *Что входит:*
• 🕐 3 персональных 45-минутных занятия
• 📊 Оценка состояния дыхания
• 💪 Индивидуальная программа тренировок
• 📹 Видеозаписи всех занятий

💎 *Преимущества:*
• 💸 Экономия 1500₽ по сравнению с покупкой отдельных занятий
• ⏰ Возможность распределить занятия в течение 1 месяца
• 📈 Отслеживание прогресса с корректировкой программы

💰 *Стоимость:* 4500₽ (экономия 1500₽)

─────────────────────────

🏆 *ПОЛНЫЙ КУРС ВИДЕОУРОКОВ - 14 999₽*
*🚧 Продукт находится в разработке*

📦 *Что будет входить:*
• 📚 Полный курс видеоуроков в настоящее время дорабатывается
• 🎯 Мы уведомим вас, когда он будет доступен для покупки
• 💡 В настоящее время вы можете приобрести другие наши продукты

📧 *Хотите узнать первыми?* Напишите @breathing_opros_bot

─────────────────────────

🤔 *КАКУЮ ПРОГРАММУ ВЫБРАТЬ?*

🆕 *Новичок в дыхательных практиках?*
→ Начните со **Стартового комплекта** (990₽)

🎯 *Хотите персональный подход?*
→ **Индивидуальная консультация** (2000₽)

💪 *Нужны серьезные изменения?*
→ **Пакет из 3-х занятий** (4500₽)

🔥 *Готовы к глубокой трансформации?*
→ Ожидайте **Полный курс** (скоро!)

👩‍⚕️ *Не знаете, что выбрать?* Напишите @breathing_opros_bot - поможем определиться!`;

    const keyboard = [
      [
        Markup.button.callback('🔥 Стартовый комплект 990₽', 'order_starter'),
        Markup.button.callback('👨‍⚕️ Консультация 2000₽', 'order_individual')
      ],
      [
        Markup.button.callback('🎯 Пакет 3 занятия 4500₽', 'order_package'),
        Markup.button.callback('📧 Узнать о полном курсе', 'order_full_course')
      ],
      [
        Markup.button.callback('🤔 Помочь выбрать программу', 'help_choose'),
        Markup.button.url('🛒 Заказать в боте', 'https://t.me/breathing_opros_bot')
      ],
      [
        Markup.button.callback('🔙 К дополнительным материалам', 'more_materials'),
        Markup.button.callback('🏠 К моей технике', 'back_to_results')
      ]
    ];

    await ctx.editMessageText(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard(keyboard)
    });
  }

  /**
   * Метод для показа деталей заказа
   */
  async showOrderDetails(ctx, programType) {
    const programs = {
      starter: {
        title: '🔥 СТАРТОВЫЙ КОМПЛЕКТ',
        price: '990₽',
        description: 'Базовый набор для начинающих с техникой К.П. Бутейко',
        action: 'Отлично! Стартовый комплект - идеальный выбор для начала.'
      },
      individual: {
        title: '👨‍⚕️ ИНДИВИДУАЛЬНАЯ КОНСУЛЬТАЦИЯ',
        price: '2000₽',
        description: 'Персональная работа с разбором вашей техники дыхания',
        action: 'Отличный выбор! Индивидуальный подход даст максимальный результат.'
      },
      package: {
        title: '🎯 ПАКЕТ ИЗ 3-Х ЗАНЯТИЙ',
        price: '4500₽',
        description: 'Комплексная программа для устойчивых результатов',
        action: 'Превосходно! Пакет занятий обеспечит серьезные изменения.'
      },
      full_course: {
        title: '🏆 ПОЛНЫЙ КУРС ВИДЕОУРОКОВ',
        price: '14 999₽',
        description: 'Находится в разработке',
        action: 'Курс дорабатывается. Запишем вас в лист ожидания!'
      }
    };

    const program = programs[programType];

    let message = `
✅ *${program.title}*

${program.action}

💰 *Стоимость:* ${program.price}
📋 *Описание:* ${program.description}

${programType === 'full_course' ? `
📧 *Мы уведомим вас, когда курс будет готов.*
А пока рекомендуем начать со Стартового комплекта!
` : `
🚀 *Следующий шаг:* перейдите в основной бот для оформления заказа.
`}

👩‍⚕️ *Вопросы?* Анастасия ответит в основном боте: @breathing_opros_bot`;

    await ctx.editMessageText(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard([
        [Markup.button.url('🛒 Заказать в основном боте', 'https://t.me/breathing_opros_bot')],
        [Markup.button.callback('🔙 К выбору программ', 'other_programs')],
        [Markup.button.callback('🏠 К моей технике', 'back_to_results')]
      ])
    });
  }

  /**
   * Помощник по выбору программы
   */
  async showProgramHelper(ctx) {
    let message = `
🤔 *ПОМОЧЬ ВЫБРАТЬ ПРОГРАММУ?*

Ответьте на несколько вопросов, и я порекомендую оптимальную программу:

❓ *Ваш опыт с дыхательными практиками:*
🆕 Никогда не занимался → **Стартовый комплект** (990₽)
📚 Есть базовые знания → **Индивидуальная консультация** (2000₽)
💪 Серьезные проблемы → **Пакет из 3 занятий** (4500₽)

❓ *Ваш бюджет:*
💸 До 1000₽ → **Стартовый комплект**
💰 До 2500₽ → **Индивидуальная консультация**
💎 До 5000₽ → **Пакет из 3 занятий**

❓ *Ваши цели:*
🎯 Попробовать и понять → **Стартовый комплект**
🔍 Разобрать мою технику → **Индивидуальная консультация**
🚀 Серьезные изменения → **Пакет из 3 занятий**

💡 *Все еще сомневаетесь?*
Напишите @breathing_opros_bot - Анастасия поможет выбрать!`;

    await ctx.editMessageText(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard([
        [
          Markup.button.callback('🔥 Выбираю стартовый!', 'order_starter'),
          Markup.button.callback('👨‍⚕️ Нужна консультация', 'order_individual')
        ],
        [
          Markup.button.callback('🎯 Беру пакет!', 'order_package'),
          Markup.button.url('💬 Спросить Анастасию', 'https://t.me/breathing_opros_bot')
        ],
        [Markup.button.callback('🔙 К программам', 'other_programs')]
      ])
    });
  }

  /**
   * Обработчик загрузки PDF для взрослых (антистресс)
   */
  async handleDownloadPdfAdultAntistress(ctx) {
    try {
      await ctx.answerCbQuery('📄 Подготавливаем PDF...');

      // Здесь должна быть логика отправки PDF файла
      await ctx.reply(
        `
📄 *PDF "Антистресс дыхание"*

Этот материал содержит:
• 5 техник быстрого снятия стресса
• Упражнения для работы и дома
• Научные основы методов

📎 *Файл будет отправлен в ближайшее время.*`,
        {
          parse_mode: 'Markdown',
          reply_markup: {
            inline_keyboard: [[{ text: '🔙 К материалам', callback_data: 'more_materials' }]]
          }
        }
      );

      logWithTime(`Пользователь ${ctx.from.id} запросил PDF антистресс для взрослых`);
    } catch (error) {
      console.error(`Ошибка при загрузке PDF антистресс: ${error.message}`);
      await ctx.answerCbQuery('Произошла ошибка при загрузке');
    }
  }

  /**
   * Обработчик загрузки PDF для детей (игры)
   */
  async handleDownloadPdfChildGames(ctx) {
    try {
      await ctx.answerCbQuery('📄 Подготавливаем PDF...');

      // Здесь должна быть логика отправки PDF файла
      await ctx.reply(
        `
📄 *PDF "Дыхательные игры для детей"*

Этот материал содержит:
• 7 игровых упражнений
• Техники для разных возрастов
• Как заинтересовать ребенка

📎 *Файл будет отправлен в ближайшее время.*`,
        {
          parse_mode: 'Markdown',
          reply_markup: {
            inline_keyboard: [[{ text: '🔙 К материалам', callback_data: 'more_materials' }]]
          }
        }
      );

      logWithTime(`Пользователь ${ctx.from.id} запросил PDF игры для детей`);
    } catch (error) {
      console.error(`Ошибка при загрузке PDF детских игр: ${error.message}`);
      await ctx.answerCbQuery('Произошла ошибка при загрузке');
    }
  }

  /**
   * Обработчик для кнопки "Назад к результатам"
   */
  async handleBackToResults(ctx) {
    try {
      await ctx.editMessageText(
        `
🏠 *Возврат к основному меню*

Выберите действие:`,
        {
          parse_mode: 'Markdown',
          reply_markup: {
            inline_keyboard: [
              [{ text: '🎁 Д premii дополнительные материалы', callback_data: 'more_materials' }],
              [{ text: '📞 Связаться с экспертом', url: 'https://t.me/breathing_opros_bot' }]
            ]
          }
        }
      );

      await ctx.answerCbQuery();
      logWithTime(`Пользователь ${ctx.from.id} вернулся к результатам`);
    } catch (error) {
      console.error(`Ошибка при возврате к результатам: ${error.message}`);
      await ctx.answerCbQuery('Произошла ошибка');
    }
  }

  /**
   * Обработчик для кнопки "К материалам"
   */
  async handleMoreMaterials(ctx) {
    try {
      await this.showMoreMaterials(ctx);
      await ctx.answerCbQuery();
    } catch (error) {
      console.error(`Ошибка при переходе к материалам: ${error.message}`);
      await ctx.answerCbQuery('Произошла ошибка');
    }
  }
}

module.exports = PDFBonusManager;
