const { Markup } = require('telegraf');
const fs = require('fs');
const path = require('path');
const config = require('../../config');

class PDFBonusManager {
  constructor() {
    // –û–±—â–∏–π —à–∞–±–ª–æ–Ω –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥–∏–¥–∞
    this.bonusesTemplate = {
      id: 'personalized_guide',
      title: 'üå¨Ô∏è –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –î–´–•–ê–¢–ï–õ–¨–ù–´–ô –ì–ò–î',
      subtitle: '–¢–µ—Ö–Ω–∏–∫–∞ –ø–æ–¥ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é',
      description: '–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ —Å –ø–ª–∞–Ω–æ–º –Ω–∞ 3 –¥–Ω—è',
      target_segments: ['HOT_LEAD', 'WARM_LEAD', 'COLD_LEAD', 'NURTURE_LEAD']
    };

    // –°—Ç–∞—Ç–∏—á–Ω—ã–µ PDF-–º–∞—Ç–µ—Ä–∏–∞–ª—ã
    this.additionalMaterials = {
      'adult_antistress': {
        url: 'https://raw.githubusercontent.com/NastuPopova/breathing-lead-bot/main/assets/pdf/antistress_breathing.pdf',
        title: 'üìÑ –ë–∞–∑–æ–≤—ã–π –≥–∏–¥ "–ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å –¥—ã—Ö–∞–Ω–∏–µ"',
        description: '–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –¥–ª—è —Å–Ω—è—Ç–∏—è —Å—Ç—Ä–µ—Å—Å–∞ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö'
      },
      'child_games': {
        url: 'https://raw.githubusercontent.com/NastuPopova/breathing-lead-bot/main/assets/pdf/child_breathing_games.pdf',
        title: 'üìÑ –ë–∞–∑–æ–≤—ã–π –≥–∏–¥ "–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –∏–≥—Ä—ã"',
        description: '–ò–≥—Ä–æ–≤—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏ –¥–ª—è –¥–µ—Ç–µ–π –≤—Å–µ—Ö –≤–æ–∑—Ä–∞—Å—Ç–æ–≤'
      }
    };

    // –¢–µ—Ö–Ω–∏–∫–∏ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö
    this.masterTechniques = {
      'chronic_stress': {
        name: '–î—ã—Ö–∞–Ω–∏–µ "4-7-8" - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —É—Å–ø–æ–∫–æ–µ–Ω–∏–µ',
        problem: '—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç—Ä–µ—Å—Å –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ',
        result: '–°–Ω—è—Ç–∏–µ —Å—Ç—Ä–µ—Å—Å–∞ –∑–∞ 2-3 –º–∏–Ω—É—Ç—ã', // –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–±—Ä–∞–Ω–∞ –ª–∞—Ç–∏–Ω—Å–∫–∞—è '–∞'
        timeframe: '–≠—Ñ—Ñ–µ–∫—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥',
        steps: [
          '–°—è–¥—å—Ç–µ —É–¥–æ–±–Ω–æ, –≤—ã–ø—Ä—è–º–∏—Ç–µ —Å–ø–∏–Ω—É',
          '–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ —Ä–æ—Ç —Å–æ –∑–≤—É–∫–æ–º "whoosh"',
          '–ó–∞–∫—Ä–æ–π—Ç–µ —Ä–æ—Ç, –≤–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ –Ω–æ—Å –Ω–∞ 4 —Å—á–µ—Ç–∞',
          '–ó–∞–¥–µ—Ä–∂–∏—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ –Ω–∞ 7 —Å—á–µ—Ç–æ–≤',
          '–í—ã–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ —Ä–æ—Ç –Ω–∞ 8 —Å—á–µ—Ç–æ–≤ —Å–æ –∑–≤—É–∫–æ–º "whoosh"',
          '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 3-4 —Ü–∏–∫–ª–∞'
        ],
        duration: '2-3 –º–∏–Ω—É—Ç—ã',
        when: '–ü—Ä–∏ –æ—Å—Ç—Ä–æ–º —Å—Ç—Ä–µ—Å—Å–µ, –ø–µ—Ä–µ–¥ –≤–∞–∂–Ω—ã–º–∏ –≤—Å—Ç—Ä–µ—á–∞–º–∏, –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö',
        science: '–ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–∞—Ä–∞—Å–∏–º–ø–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É, —Å–Ω–∏–∂–∞–µ—Ç –∫–æ—Ä—Ç–∏–∑–æ–ª',
        emergency_note: '–ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≥–¥–µ —É–≥–æ–¥–Ω–æ - –≤ –æ—Ñ–∏—Å–µ, –º–∞—à–∏–Ω–µ, –¥–æ–º–∞'
      },
      'anxiety': {
        name: '–¢–µ—Ö–Ω–∏–∫–∞ "5-4-3-2-1" - —Å—Ç–æ–ø –ø–∞–Ω–∏–∫–∞',
        problem: '—Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –∏ –ø–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏',
        result: '–ë—ã—Å—Ç—Ä–æ–µ –∑–∞–∑–µ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–∞–Ω–∏–∫–µ',
        timeframe: '–û–±–ª–µ–≥—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã',
        steps: [
          '–ü–û–°–ú–û–¢–†–ò–¢–ï: –ù–∞–∑–æ–≤–∏—Ç–µ 5 –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—Ç–µ',
          '–£–°–õ–´–®–¨–¢–ï: –ù–∞–∑–æ–≤–∏—Ç–µ 4 –∑–≤—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—ã—à–∏—Ç–µ',
          '–ü–û–¢–†–û–ì–ê–ô–¢–ï: –ù–∞–∑–æ–≤–∏—Ç–µ 3 –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç–µ –ø–æ—Ç—Ä–æ–≥–∞—Ç—å',
          '–ü–û–ù–Æ–•–ê–ô–¢–ï: –ù–∞–∑–æ–≤–∏—Ç–µ 2 –∑–∞–ø–∞—Ö–∞',
          '–ü–û–ü–†–û–ë–£–ô–¢–ï: –ù–∞–∑–æ–≤–∏—Ç–µ 1 –≤–∫—É—Å',
          '–î—ã—à–∏—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–æ: –≤–¥–æ—Ö –Ω–∞ 4, –≤—ã–¥–æ—Ö –Ω–∞ 6'
        ],
        duration: '3-5 –º–∏–Ω—É—Ç',
        when: '–ü—Ä–∏ –ø–∞–Ω–∏—á–µ—Å–∫–∏—Ö –∞—Ç–∞–∫–∞—Ö, —Å–∏–ª—å–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–µ, –Ω–∞–≤—è–∑—á–∏–≤—ã—Ö –º—ã—Å–ª—è—Ö',
        science: '–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–µ–ª–æ, –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω—ã–µ –º—ã—Å–ª–∏',
        emergency_note: '–†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –≤ —Å–∞–º—ã—Ö —Å–∏–ª—å–Ω—ã—Ö –ø—Ä–∏—Å—Ç—É–ø–∞—Ö –ø–∞–Ω–∏–∫–∏'
      },
      'insomnia': {
        name: '–î—ã—Ö–∞–Ω–∏–µ "4-7-8" –¥–ª—è —Å–Ω–∞',
        problem: '–±–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞ –∏ –ø–ª–æ—Ö–æ–π —Å–æ–Ω',
        result: '–ë—ã—Å—Ç—Ä–æ–µ –∑–∞—Å—ã–ø–∞–Ω–∏–µ',
        timeframe: '–ó–∞—Å—ã–ø–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 5-10 –º–∏–Ω—É—Ç',
        steps: [
          '–õ—è–≥—Ç–µ –≤ –∫—Ä–æ–≤–∞—Ç—å, —É—Å—Ç—Ä–æ–π—Ç–µ—Å—å —É–¥–æ–±–Ω–æ',
          '–í—ã–¥–æ—Ö–Ω–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —á–µ—Ä–µ–∑ —Ä–æ—Ç',
          '–ó–∞–∫—Ä–æ–π—Ç–µ —Ä–æ—Ç, –≤–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ –Ω–æ—Å –Ω–∞ 4 —Å—á–µ—Ç–∞',
          '–ó–∞–¥–µ—Ä–∂–∏—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ –Ω–∞ 7 —Å—á–µ—Ç–æ–≤',
          '–í—ã–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ —Ä–æ—Ç –Ω–∞ 8 —Å—á–µ—Ç–æ–≤',
          '–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ, –ø–æ–∫–∞ –Ω–µ –∑–∞—Å–Ω–µ—Ç–µ'
        ],
        duration: '5-15 –º–∏–Ω—É—Ç',
        when: '–ü–µ—Ä–µ–¥ —Å–Ω–æ–º, –ø—Ä–∏ –Ω–æ—á–Ω—ã—Ö –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è—Ö',
        science: '–ó–∞–º–µ–¥–ª—è–µ—Ç —Å–µ—Ä–¥–µ—á–Ω—ã–π —Ä–∏—Ç–º, —Ä–∞—Å—Å–ª–∞–±–ª—è–µ—Ç –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É',
        emergency_note: '–ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –¥–∞–∂–µ –≤ –ø–æ–ª–Ω–æ–π —Ç–µ–º–Ω–æ—Ç–µ, –Ω–µ –≤—Å—Ç–∞–≤–∞—è —Å –∫—Ä–æ–≤–∞—Ç–∏'
      },
      'breathing_issues': {
        name: '–î–∏–∞—Ñ—Ä–∞–≥–º–∞–ª—å–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ "–†—É–∫–∞ –Ω–∞ –∂–∏–≤–æ—Ç–µ"',
        problem: '–ø—Ä–æ–±–ª–µ–º—ã —Å –¥—ã—Ö–∞–Ω–∏–µ–º –∏ –æ–¥—ã—à–∫–∞',
        result: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –¥—ã—Ö–∞–Ω–∏—è',
        timeframe: '–£–ª—É—á—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3-5 –¥–Ω–µ–π',
        steps: [
          '–õ—è–≥—Ç–µ –∏–ª–∏ —Å—è–¥—å—Ç–µ —É–¥–æ–±–Ω–æ',
          '–û–¥–Ω—É —Ä—É–∫—É –ø–æ–ª–æ–∂–∏—Ç–µ –Ω–∞ –≥—Ä—É–¥—å, –¥—Ä—É–≥—É—é –Ω–∞ –∂–∏–≤–æ—Ç',
          '–î—ã—à–∏—Ç–µ —Ç–∞–∫, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞–ª–∞—Å—å —Ç–æ–ª—å–∫–æ —Ä—É–∫–∞ –Ω–∞ –∂–∏–≤–æ—Ç–µ',
          '–í–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å 4 —Å–µ–∫—É–Ω–¥—ã - –∂–∏–≤–æ—Ç –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è',
          '–í—ã–¥–æ—Ö —á–µ—Ä–µ–∑ —Ä–æ—Ç 6 —Å–µ–∫—É–Ω–¥ - –∂–∏–≤–æ—Ç –æ–ø—É—Å–∫–∞–µ—Ç—Å—è',
          '–ì—Ä—É–¥—å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π'
        ],
        duration: '5-10 –º–∏–Ω—É—Ç',
        when: '–ü—Ä–∏ –æ–¥—ã—à–∫–µ, –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –¥—ã—Ö–∞–Ω–∏—è',
        science: '–£–∫—Ä–µ–ø–ª—è–µ—Ç –¥–∏–∞—Ñ—Ä–∞–≥–º—É, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—ä–µ–º –ª–µ–≥–∫–∏—Ö',
        emergency_note: '–û—Å–Ω–æ–≤–∞ –≤—Å–µ—Ö –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫'
      },
      'high_pressure': {
        name: '–ö–æ–≥–µ—Ä–µ–Ω—Ç–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ "5-5"',
        problem: '–ø–æ–≤—ã—à–µ–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ',
        result: '–°–Ω–∏–∂–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è',
        timeframe: '–≠—Ñ—Ñ–µ–∫—Ç —á–µ—Ä–µ–∑ 10-15 –º–∏–Ω—É—Ç',
        steps: [
          '–°—è–¥—å—Ç–µ —É–¥–æ–±–Ω–æ, –Ω–æ–≥–∏ –Ω–∞ –ø–æ–ª—É',
          '–í–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å –Ω–∞ 5 —Å—á–µ—Ç–æ–≤',
          '–í—ã–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å –Ω–∞ 5 —Å—á–µ—Ç–æ–≤',
          '–î—ã—à–∏—Ç–µ –±–µ–∑ –ø–∞—É–∑ –∏ –∑–∞–¥–µ—Ä–∂–µ–∫',
          '–†–∏—Ç–º: 6 –¥—ã—Ö–∞–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É',
          '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ 15-20 –º–∏–Ω—É—Ç'
        ],
        duration: '15-20 –º–∏–Ω—É—Ç',
        when: '–ü—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ –¥–∞–≤–ª–µ–Ω–∏—è, –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏',
        science: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Ä–¥–µ—á–Ω—ã–π —Ä–∏—Ç–º, —Å–Ω–∏–∂–∞–µ—Ç –¥–∞–≤–ª–µ–Ω–∏–µ',
        emergency_note: '–ò–∑–º–µ—Ä—è–π—Ç–µ –¥–∞–≤–ª–µ–Ω–∏–µ –¥–æ –∏ –ø–æ—Å–ª–µ –ø—Ä–∞–∫—Ç–∏–∫–∏'
      },
      'fatigue': {
        name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–µ –¥—ã—Ö–∞–Ω–∏–µ "–í–æ–∑–¥—É—à–Ω—ã–π –Ω–∞—Å–æ—Å"',
        problem: '—Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å',
        result: '–ü—Ä–∏–ª–∏–≤ —ç–Ω–µ—Ä–≥–∏–∏ –∏ –±–æ–¥—Ä–æ—Å—Ç–∏',
        timeframe: '–≠–Ω–µ—Ä–≥–∏—è —á–µ—Ä–µ–∑ 3-5 –º–∏–Ω—É—Ç',
        steps: [
          '–í—Å—Ç–∞–Ω—å—Ç–µ –ø—Ä—è–º–æ, —Ä—É–∫–∏ –Ω–∞ –ø–æ—è—Å',
          '–ë—ã—Å—Ç—Ä—ã–π –≤–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å - –∂–∏–≤–æ—Ç –≤–ø–µ—Ä–µ–¥',
          '–ë—ã—Å—Ç—Ä—ã–π –≤—ã–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å - –∂–∏–≤–æ—Ç –Ω–∞–∑–∞–¥',
          '–¢–µ–º–ø: 1 —Ü–∏–∫–ª –≤ —Å–µ–∫—É–Ω–¥—É',
          '–°–¥–µ–ª–∞–π—Ç–µ 30 –±—ã—Å—Ç—Ä—ã—Ö —Ü–∏–∫–ª–æ–≤',
          '–ó–∞—Ç–µ–º 3 –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–∞'
        ],
        duration: '3-5 –º–∏–Ω—É—Ç',
        when: '–ü—Ä–∏ —É–ø–∞–¥–∫–µ —Å–∏–ª, —Å–æ–Ω–ª–∏–≤–æ—Å—Ç–∏, –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –¥–Ω—è',
        science: '–ù–∞—Å—ã—â–∞–µ—Ç –∫—Ä–æ–≤—å –∫–∏—Å–ª–æ—Ä–æ–¥–æ–º, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –Ω–µ—Ä–≤–Ω—É—é —Å–∏—Å—Ç–µ–º—É',
        emergency_note: '–ù–µ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–º –¥–∞–≤–ª–µ–Ω–∏–∏'
      },
      'weak_immunity': {
        name: '–î—ã—Ö–∞–Ω–∏–µ "–ü–æ–ª–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ –π–æ–≥–∏"',
        problem: '—Å–ª–∞–±—ã–π –∏–º–º—É–Ω–∏—Ç–µ—Ç',
        result: '–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∏–º–º—É–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã',
        timeframe: '–£–ª—É—á—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1-2 –Ω–µ–¥–µ–ª–∏',
        steps: [
          '–°—è–¥—å—Ç–µ –ø—Ä—è–º–æ, —Ä–∞—Å—Å–ª–∞–±—å—Ç–µ –ø–ª–µ—á–∏',
          '–í–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å: —Å–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–æ–ª–Ω–∏—Ç–µ –∂–∏–≤–æ—Ç, –∑–∞—Ç–µ–º –≥—Ä—É–¥—å',
          '–ó–∞–¥–µ—Ä–∂–∫–∞ –¥—ã—Ö–∞–Ω–∏—è –Ω–∞ 2-3 —Å–µ–∫—É–Ω–¥—ã',
          '–í—ã–¥–æ—Ö —á–µ—Ä–µ–∑ –Ω–æ—Å: —Å–Ω–∞—á–∞–ª–∞ –æ–ø—É—Å—Ç–∏—Ç–µ –≥—Ä—É–¥—å, –∑–∞—Ç–µ–º –∂–∏–≤–æ—Ç',
          '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 5-10 —Ü–∏–∫–ª–æ–≤'
        ],
        duration: '5-10 –º–∏–Ω—É—Ç',
        when: '–£—Ç—Ä–æ–º –∏–ª–∏ –≤–µ—á–µ—Ä–æ–º, –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏',
        science: '–£–ª—É—á—à–∞–µ—Ç –≤–µ–Ω—Ç–∏–ª—è—Ü–∏—é –ª–µ–≥–∫–∏—Ö, –ø–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∫–∏—Å–ª–æ—Ä–æ–¥–∞',
        emergency_note: '–î–µ–ª–∞–π—Ç–µ –≤ –ø—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–µ–º–æ–º –ø–æ–º–µ—â–µ–Ω–∏–∏'
      }
    };

    // –¢–µ—Ö–Ω–∏–∫–∏ –¥–ª—è –¥–µ—Ç–µ–π
    this.childMasterTechniques = {
      'anxiety': {
        name: '–ò–≥—Ä–∞ "–ú–µ–¥–≤–µ–∂–æ–Ω–æ–∫ —Å–ø–∏—Ç"',
        problem: '—Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä–∞—Ö–∏',
        result: '–ë—ã—Å—Ç—Ä–æ–µ —É—Å–ø–æ–∫–æ–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞',
        timeframe: '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç',
        steps: [
          '–î–∞–π—Ç–µ —Ä–µ–±–µ–Ω–∫—É –ª—é–±–∏–º—É—é –º—è–≥–∫—É—é –∏–≥—Ä—É—à–∫—É',
          '–ü—É—Å—Ç—å —Ä–µ–±–µ–Ω–æ–∫ –ª—è–∂–µ—Ç –∏ –ø–æ–ª–æ–∂–∏—Ç –∏–≥—Ä—É—à–∫—É –Ω–∞ –∂–∏–≤–æ—Ç–∏–∫',
          '–°–∫–∞–∂–∏—Ç–µ: "–ü–æ–∫–∞–∂–∏, –∫–∞–∫ —Å–ø–∏—Ç –º–∏—à–∫–∞"',
          '–í–¥–æ—Ö –Ω–æ—Å–∏–∫–æ–º: –º–∏—à–∫–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ –∂–∏–≤–æ—Ç–∏–∫–µ',
          '–í—ã–¥–æ—Ö —Ä–æ—Ç–∏–∫–æ–º: –º–∏—à–∫–∞ –æ–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ –∑–∞—Å—ã–ø–∞–µ—Ç',
          '–°—á–∏—Ç–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ: "–ú–∏—à–∫–∞ —Å–ø–∏—Ç 1-2-3-4"'
        ],
        duration: '5-10 –º–∏–Ω—É—Ç',
        when: '–ü—Ä–∏ —Å—Ç—Ä–∞—Ö–∞—Ö, –∫–∞–ø—Ä–∏–∑–∞—Ö, –ø–µ—Ä–µ–¥ —Å–Ω–æ–º',
        parent_tip: '–î–µ–ª–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ —Å —Ä–µ–±–µ–Ω–∫–æ–º, –≥–æ–≤–æ—Ä–∏—Ç–µ —Å–ø–æ–∫–æ–π–Ω—ã–º –≥–æ–ª–æ—Å–æ–º',
        age_note: '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ—Ç–µ–π 3-12 –ª–µ—Ç'
      },
      'hyperactivity': {
        name: '–ò–≥—Ä–∞ "–°—Ç–æ–ø-–¥—ã—Ö–∞–Ω–∏–µ"',
        problem: '–≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –Ω–µ–≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å',
        result: '–£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏',
        timeframe: '–°–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç',
        steps: [
          '–í–∫–ª—é—á–∏—Ç–µ –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É —Ä–µ–±–µ–Ω–∫–∞',
          '–¢–∞–Ω—Ü—É–π—Ç–µ –∏ –¥–≤–∏–≥–∞–π—Ç–µ—Å—å –≤–º–µ—Å—Ç–µ',
          '–ö–æ–≥–¥–∞ –º—É–∑—ã–∫–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è - –∫—Ä–∏—á–∏—Ç–µ "–°–¢–û–ü!"',
          '–í—Å–µ –∑–∞–º–∏—Ä–∞—é—Ç –∫–∞–∫ —Å—Ç–∞—Ç—É–∏',
          '–î–µ–ª–∞–µ—Ç–µ 3 –≥–ª—É–±–æ–∫–∏—Ö –≤–¥–æ—Ö–∞ –≤–º–µ—Å—Ç–µ',
          '–°–Ω–æ–≤–∞ –≤–∫–ª—é—á–∞–µ—Ç–µ –º—É–∑—ã–∫—É –∏ —Ç–∞–Ω—Ü—É–µ—Ç–µ'
        ],
        duration: '10-15 –º–∏–Ω—É—Ç',
        when: '–ü—Ä–∏ –≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è',
        parent_tip: '–ò–≥—Ä–∞–π—Ç–µ —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º, —Ö–≤–∞–ª–∏—Ç–µ —Ä–µ–±–µ–Ω–∫–∞',
        age_note: '–û—Å–æ–±–µ–Ω–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –¥–µ—Ç–µ–π 5-10 –ª–µ—Ç'
      },
      'sleep_problems': {
        name: '–î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è —Å–∫–∞–∑–∫–∞ "–í–æ–∑–¥—É—à–Ω—ã–π —à–∞—Ä–∏–∫"',
        problem: '–ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–Ω–æ–º',
        result: '–ë—ã—Å—Ç—Ä–æ–µ –∑–∞—Å—ã–ø–∞–Ω–∏–µ',
        timeframe: '–ó–∞—Å—ã–ø–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 10-15 –º–∏–Ω—É—Ç',
        steps: [
          '–†–µ–±–µ–Ω–æ–∫ –ª–æ–∂–∏—Ç—Å—è –≤ –∫—Ä–æ–≤–∞—Ç—å, –∫–ª–∞–¥–µ—Ç —Ä—É–∫–∏ –Ω–∞ –∂–∏–≤–æ—Ç–∏–∫',
          '–ì–æ–≤–æ—Ä–∏—Ç–µ: "–í –∂–∏–≤–æ—Ç–∏–∫–µ –∂–∏–≤–µ—Ç –≤–æ–ª—à–µ–±–Ω—ã–π —à–∞—Ä–∏–∫"',
          '–í–¥–æ—Ö –Ω–æ—Å–∏–∫–æ–º: "–®–∞—Ä–∏–∫ –Ω–∞–¥—É–≤–∞–µ—Ç—Å—è –∏ —Ä–∞—Å—Ç–µ—Ç"',
          '–í—ã–¥–æ—Ö —Ä–æ—Ç–∏–∫–æ–º: "–®–∞—Ä–∏–∫ —Å–¥—É–≤–∞–µ—Ç—Å—è –∏ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è"',
          '–°—á–∏—Ç–∞–π—Ç–µ: "–®–∞—Ä–∏–∫ —Ä–∞—Å—Ç–µ—Ç 1-2-3-4"',
          '–ò: "–®–∞—Ä–∏–∫ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è 1-2-3-4-5-6"'
        ],
        duration: '10-15 –º–∏–Ω—É—Ç',
        when: '–ü–µ—Ä–µ–¥ —Å–Ω–æ–º, –ø—Ä–∏ –Ω–æ—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ö–∞—Ö',
        parent_tip: '–ì–æ–≤–æ—Ä–∏—Ç–µ —Ç–∏—Ö–∏–º, —É–±–∞—é–∫–∏–≤–∞—é—â–∏–º –≥–æ–ª–æ—Å–æ–º',
        age_note: '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ—Ç–µ–π 3-8 –ª–µ—Ç'
      },
      'weak_immunity': {
        name: '–ò–≥—Ä–∞ "–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–π –ª–µ—Å"',
        problem: '—Å–ª–∞–±—ã–π –∏–º–º—É–Ω–∏—Ç–µ—Ç',
        result: '–£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∏–º–º—É–Ω–∏—Ç–µ—Ç–∞ —á–µ—Ä–µ–∑ –∏–≥—Ä—É',
        timeframe: '–£–ª—É—á—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1-2 –Ω–µ–¥–µ–ª–∏',
        steps: [
          '–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ, —á—Ç–æ –≤—ã –≤ –ª–µ—Å—É —Å –¥–µ—Ä–µ–≤—å—è–º–∏',
          '–í–¥–æ—Ö –Ω–æ—Å–æ–º: "–î–µ—Ä–µ–≤—å—è —Ä–∞—Å—Ç—É—Ç –∏ –Ω–∞–±–∏—Ä–∞—é—Ç —Å–∏–ª—É"',
          '–í—ã–¥–æ—Ö —Ä—Ç–æ–º: "–î–µ—Ä–µ–≤—å—è –¥–µ–ª—è—Ç—Å—è —Å–∏–ª–æ–π —Å –≤–∞–º–∏"',
          '–°—á–∏—Ç–∞–π—Ç–µ: "–†–∞—Å—Ç–µ–º 1-2-3", "–î—ã—à–∏–º 1-2-3-4"',
          '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 5 —Ä–∞–∑'
        ],
        duration: '5-10 –º–∏–Ω—É—Ç',
        when: '–£—Ç—Ä–æ–º –∏–ª–∏ –≤–µ—á–µ—Ä–æ–º, –¥–ª—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∏',
        parent_tip: '–î–æ–±–∞–≤—å—Ç–µ –∏–≥—Ä—É—à–∫–∏-–¥–µ—Ä–µ–≤—å—è –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–∞',
        age_note: '–ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–µ—Ç–µ–π 5-15 –ª–µ—Ç'
      }
    };

    this.stats = {
      available_techniques: Object.keys(this.masterTechniques).length + Object.keys(this.childMasterTechniques).length,
      approach: 'minimalist',
      last_updated: new Date().toISOString()
    };

    this.deliveryLog = [];
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HTML-–∫–æ–Ω—Ç–µ–Ω—Ç
   */
  async generatePersonalizedHTML(userId, analysisResult, surveyData) {
    try {
      if (!fs.existsSync('./temp')) {
        fs.mkdirSync('./temp', { recursive: true });
      }

      const filePath = `./temp/bonus_${userId}.html`;
      
      // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      const technique = this.getMasterTechnique(analysisResult, surveyData);
      const title = this.generatePersonalizedTitle(analysisResult, surveyData);
      const subtitle = this.generatePersonalizedSubtitle(analysisResult, surveyData);
      const isChildFlow = analysisResult.analysisType === 'child';
      const threeDayPlan = this.generate3DayPlan(technique, isChildFlow, analysisResult.segment);

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —ç–º–æ–¥–∑–∏
      const cleanText = (text) => {
        return text.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '');
      };

      // –ü–æ–ª–Ω—ã–π HTML —Å DOCTYPE –∏ —Å—Ç–∏–ª—è–º–∏
      let htmlContent = `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${cleanText(title)}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      line-height: 1.6;
      color: #333;
      background-color: #f9f9f9;
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      font-size: 24px;
    }
    h2 {
      color: #34495e;
      font-size: 20px;
      margin-top: 20px;
    }
    h3 {
      color: #34495e;
      font-size: 18px;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .urgent {
      background: #ffebee;
      border-left: 4px solid #e74c3c;
      padding: 15px;
      margin-bottom: 20px;
      color: #c0392b;
    }
    ul {
      list-style-type: disc;
      padding-left: 20px;
    }
    .progress-bar {
      background: #ecf0f1;
      height: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .progress {
      background: #3498db;
      height: 100%;
      border-radius: 5px;
    }
    .cta {
      text-align: center;
      background: #e8f4f8;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .button {
      display: inline-block;
      padding: 10px 20px;
      background: #3498db;
      color: #fff;
      text-decoration: none;
      border-radius: 5px;
      margin: 10px;
    }
    .footer {
      text-align: center;
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="section">
    <h1>${cleanText(title)}</h1>
    <h2>${cleanText(subtitle)}</h2>
    <p>–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –¥—ã—Ö–∞–Ω–∏—è</p>
  </div>
`;

      // –°—Ä–æ—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è HOT_LEAD
      if (analysisResult.segment === 'HOT_LEAD') {
        htmlContent += `
  <div class="urgent">
    <p>‚ö° –°–†–û–ß–ù–û: –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã.</p>
    <p>–û—Å–≤–æ–π—Ç–µ —ç—Ç—É —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –æ–Ω–∞ –ø–æ–º–æ–∂–µ—Ç —É–∂–µ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã!</p>
  </div>
`;
      }

      // –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      htmlContent += `
  <div class="section">
    <h2>üìä –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
    <ul>
`;
      if (isChildFlow) {
        if (surveyData.child_age_detail) {
          htmlContent += `      <li>–í–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞: ${this.translateValue(surveyData.child_age_detail)}</li>\n`;
        }
        if (surveyData.child_problems_detailed) {
          const problems = this.translateArray(surveyData.child_problems_detailed).slice(0, 2).join(', ');
          htmlContent += `      <li>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã: ${problems}</li>\n`;
        }
        if (surveyData.child_parent_involvement) {
          htmlContent += `      <li>–ö—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è: ${this.translateValue(surveyData.child_parent_involvement)}</li>\n`;
        }
      } else {
        if (surveyData.age_group) {
          htmlContent += `      <li>–í–æ–∑—Ä–∞—Å—Ç: ${this.translateValue(surveyData.age_group)}</li>\n`;
        }
        if (surveyData.stress_level) {
          const stressDesc = this.getStressDescription(surveyData.stress_level);
          htmlContent += `      <li>–£—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–µ—Å—Å–∞: ${surveyData.stress_level}/10 (${stressDesc})</li>\n`;
        }
        if (surveyData.current_problems) {
          const problems = this.translateArray(surveyData.current_problems).slice(0, 2).join(', ');
          htmlContent += `      <li>–ü—Ä–æ–±–ª–µ–º—ã: ${problems}</li>\n`;
        }
      }

      const segmentNames = {
        'HOT_LEAD': '–¢—Ä–µ–±—É–µ—Ç —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è',
        'WARM_LEAD': '–ê–∫—Ç–∏–≤–Ω–æ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º',
        'COLD_LEAD': '–£–º–µ—Ä–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–∞–∫—Ç–∏–∫–∞–º',
        'NURTURE_LEAD': '–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ'
      };

      htmlContent += `
      <li>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${segmentNames[analysisResult.segment]}</li>
      <li>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: ${technique.problem}</li>
    </ul>
  </div>
`;

      // –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞
      htmlContent += `
  <div class="section">
    <h2>${technique.name}</h2>
    <p><strong>–†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É:</strong> ${technique.problem}</p>
    <ul>
`;
      technique.steps.forEach(step => {
        htmlContent += `      <li>${step}</li>\n`;
      });
      htmlContent += `
    </ul>
    <p><strong>‚è±Ô∏è –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</strong> ${technique.duration}</p>
    <p><strong>‚ú® –†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ${technique.timeframe}</p>
    <p><strong>üí° –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${technique.science || '–ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ —Å –¥–æ–∫–∞–∑–∞–Ω–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é'}</p>
`;
      if (technique.emergency_note) {
        htmlContent += `    <p><strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong> ${technique.emergency_note}</p>\n`;
      }
      if (technique.parent_tip && isChildFlow) {
        htmlContent += `    <p><strong>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–æ–≤–µ—Ç —Ä–æ–¥–∏—Ç–µ–ª—è–º:</strong> ${technique.parent_tip}</p>\n`;
      }
      htmlContent += `
  </div>
`;

      // –ü–ª–∞–Ω –Ω–∞ 3 –¥–Ω—è
      htmlContent += `
  <div class="section">
    <h2>üìÖ –ü–õ–ê–ù –û–°–í–û–ï–ù–ò–Ø –ù–ê 3 –î–ù–Ø</h2>
`;
      Object.entries(threeDayPlan).forEach(([day, plan], index) => {
        const progress = ((index + 1) / 3) * 100;
        htmlContent += `
    <div>
      <h3>${plan.title}</h3>
      <ul>
`;
        plan.tasks.forEach(task => {
          htmlContent += `        <li>${task}</li>\n`;
        });
        htmlContent += `
      </ul>
      <p><strong>üéØ –¶–µ–ª—å –¥–Ω—è:</strong> ${plan.goal}</p>
      <div class="progress-bar">
        <div class="progress" style="width: ${progress}%"></div>
      </div>
    </div>
`;
      });
      htmlContent += `
  </div>
`;

      // –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      htmlContent += `
  <div class="section">
    <h2>üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´</h2>
    <ul>
`;
      if (isChildFlow) {
        htmlContent += `
      <li>üìà –£–ª—É—á—à–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è —á–µ—Ä–µ–∑ 2-3 –¥–Ω—è</li>
      <li>üò¥ –ë–æ–ª–µ–µ —Å–ø–æ–∫–æ–π–Ω—ã–π —Å–æ–Ω –∏ –∑–∞—Å—ã–ø–∞–Ω–∏–µ</li>
      <li>üéØ –†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤ —Å–∞–º–æ—É—Å–ø–æ–∫–æ–µ–Ω–∏—è</li>
      <li>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –£–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏</li>
`;
      } else {
        htmlContent += `
      <li>‚ö° ${technique.result}</li>
      <li>üìà –°–Ω–∏–∂–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å—Ç—Ä–µ—Å—Å–∞</li>
      <li>üí™ –†–∞–∑–≤–∏—Ç–∏–µ –Ω–∞–≤—ã–∫–æ–≤ —Å–∞–º–æ–ø–æ–º–æ—â–∏</li>
      <li>üåü –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—â–µ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è</li>
`;
      }
      htmlContent += `
    </ul>
  </div>
`;

      // –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ CTA
      htmlContent += `
  <div class="cta">
    <h2>üìû –•–û–¢–ò–¢–ï –ë–û–õ–¨–®–ï –¢–ï–•–ù–ò–ö?</h2>
    <p>–≠—Ç–æ —Ç–æ–ª—å–∫–æ 1 –∏–∑ 15+ —Ç–µ—Ö–Ω–∏–∫ –≤ –º–æ–µ–π –∞–≤—Ç–æ—Ä—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ!</p>
    <p>–ù–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ–¥–±–µ—Ä–µ–º –ø–æ–ª–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é.</p>
    <p><strong>üë©‚Äç‚öïÔ∏è –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ü–æ–ø–æ–≤–∞</strong><br>–≠–∫—Å–ø–µ—Ä—Ç –ø–æ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∞–∫—Ç–∏–∫–∞–º<br>Telegram: @NastuPopova</p>
    <a href="https://t.me/NastuPopova" class="button">üí¨ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</a>
    <a href="https://t.me/NastuPopova" class="button">üìû –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å</a>
    <p>üíù –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç: –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫–∏ –ø–æ–¥ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É ‚Ä¢ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π ‚Ä¢ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å ‚Ä¢ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã</p>
  </div>
`;

      // –§—É—Ç–µ—Ä
      htmlContent += `
  <div class="footer">
    <p>–°–æ–∑–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å ‚Ä¢ ${new Date().toLocaleDateString('ru-RU')}</p>
    <p>–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–æ–ø–æ–ª–Ω—è—é—Ç, –Ω–æ –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ –ª–µ—á–µ–Ω–∏–µ</p>
    <p><strong>üå¨Ô∏è –ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –≤–∞—à–µ –¥—ã—Ö–∞–Ω–∏–µ –∏–∑–º–µ–Ω–∏—Ç –≤–∞—à—É –∂–∏–∑–Ω—å!</strong></p>
  </div>
</body>
</html>
`;

      // –ó–∞–ø–∏—Å—å HTML-—Ñ–∞–π–ª–∞
      fs.writeFileSync(filePath, htmlContent, 'utf8');
      console.log(`‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π HTML —Å–æ–∑–¥–∞–Ω: ${filePath}`);
      return filePath;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ HTML:', {
        error: error.message,
        stack: error.stack,
        userId,
        analysisResult,
        surveyData
      });
      throw error;
    }
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –æ–¥–Ω—É –º–∞—Å—Ç–µ—Ä-—Ç–µ—Ö–Ω–∏–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  getMasterTechnique(analysisResult, surveyData) {
    if (!analysisResult || !surveyData) {
      throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–µ—Ö–Ω–∏–∫–∏');
    }
    const isChildFlow = analysisResult.analysisType === 'child';
    const primaryIssue = analysisResult.primaryIssue || 'chronic_stress';
    
    if (isChildFlow) {
      return this.childMasterTechniques[primaryIssue] || this.childMasterTechniques['anxiety'];
    } else {
      return this.masterTechniques[primaryIssue] || this.masterTechniques['chronic_stress'];
    }
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
   */
  generatePersonalizedTitle(analysisResult, surveyData) {
    const isChildFlow = analysisResult.analysisType === 'child';
    const primaryIssue = analysisResult.primaryIssue;
    const segment = analysisResult.segment;

    if (isChildFlow) {
      const titles = {
        'anxiety': 'üß∏ –°–ü–û–ö–û–ô–ù–´–ô –†–ï–ë–ï–ù–û–ö',
        'hyperactivity': 'üéØ –ö–û–ù–¶–ï–ù–¢–†–ê–¶–ò–Ø –†–ï–ë–ï–ù–ö–ê', 
        'sleep_problems': 'üò¥ –ö–†–ï–ü–ö–ò–ô –°–û–ù –†–ï–ë–ï–ù–ö–ê',
        'weak_immunity': 'üå≥ –ó–î–û–†–û–í–´–ô –†–ï–ë–ï–ù–û–ö'
      };
      return titles[primaryIssue] || 'üåü –î–´–•–ê–ù–ò–ï –î–õ–Ø –†–ï–ë–ï–ù–ö–ê';
    } else {
      if (segment === 'HOT_LEAD') {
        const hotTitles = {
          'chronic_stress': 'üö® SOS –û–¢ –°–¢–†–ï–°–°–ê',
          'anxiety': 'üö® SOS –û–¢ –ü–ê–ù–ò–ö–ò',
          'insomnia': 'üö® SOS –î–õ–Ø –°–ù–ê',
          'breathing_issues': 'üö® SOS –î–´–•–ê–ù–ò–ï',
          'high_pressure': 'üö® SOS –î–ê–í–õ–ï–ù–ò–ï',
          'weak_immunity': 'üö® SOS –ò–ú–ú–£–ù–ò–¢–ï–¢'
        };
        return hotTitles[primaryIssue] || 'üö® SOS –¢–ï–•–ù–ò–ö–ê';
      } else {
        const titles = {
          'chronic_stress': 'üå¨Ô∏è –ê–ù–¢–ò–°–¢–†–ï–°–° –î–´–•–ê–ù–ò–ï',
          'anxiety': 'üå¨Ô∏è –°–¢–û–ü –ü–ê–ù–ò–ö–ê',
          'insomnia': 'üå¨Ô∏è –î–´–•–ê–ù–ò–ï –î–õ–Ø –°–ù–ê',
          'breathing_issues': 'üå¨Ô∏è –ü–†–ê–í–ò–õ–¨–ù–û–ï –î–´–•–ê–ù–ò–ï',
          'high_pressure': 'üå¨Ô∏è –î–´–•–ê–ù–ò–ï –û–¢ –î–ê–í–õ–ï–ù–ò–Ø',
          'fatigue': 'üå¨Ô∏è –≠–ù–ï–†–ì–ò–Ø –î–´–•–ê–ù–ò–Ø',
          'weak_immunity': 'üå¨Ô∏è –£–ö–†–ï–ü–õ–ï–ù–ò–ï –ò–ú–ú–£–ù–ò–¢–ï–¢–ê'
        };
        return titles[primaryIssue] || 'üå¨Ô∏è –î–´–•–ê–¢–ï–õ–¨–ù–ê–Ø –¢–ï–•–ù–ò–ö–ê';
      }
    }
  }

  /**
   * –°–æ–∑–¥–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
   */
  generatePersonalizedSubtitle(analysisResult, surveyData) {
    const technique = this.getMasterTechnique(analysisResult, surveyData);
    return `${technique.result} –∑–∞ ${technique.duration}`;
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—á–Ω—ã–µ PDF
   */
  async sendAdditionalPDF(ctx, pdfType) {
    console.log(`üì• –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ PDF: ${pdfType}`);
    
    const pdf = this.additionalMaterials[pdfType];
    if (!pdf) {
      console.error(`‚ùå PDF —Å —Ç–∏–ø–æ–º ${pdfType} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ additionalMaterials`);
      console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ PDF:', Object.keys(this.additionalMaterials));
      
      await ctx.reply('‚ö†Ô∏è –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π PDF –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –°–≤—è–∂–∏—Ç–µ—Å—å —Å @NastuPopova –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞!', {
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard([
          [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')]
        ])
      });
      return;
    }
    
    const message = `üéÅ *–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ë–û–ù–£–°*\n\n` +
      `${pdf.title}\n\n` +
      `üìù *–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏:* ${pdf.description}\n\n` +
      `üí° *–î–æ–ø–æ–ª–Ω—è–µ—Ç –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥* - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞!\n\n` +
      `üìû *–•–æ—Ç–∏—Ç–µ –µ—â–µ –±–æ–ª—å—à–µ —Ç–µ—Ö–Ω–∏–∫?* –ó–∞–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é: @NastuPopova`;
    
    try {
      console.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º PDF –ø–æ URL: ${pdf.url}`);
      
      await ctx.replyWithDocument({ url: pdf.url }, {
        caption: message,
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard([
          [Markup.button.url('üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é', 'https://t.me/NastuPopova')],
          [Markup.button.callback('üîô –ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º', 'more_materials')]
        ])
      });

      console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å—Ç–∞—Ç–∏—á–Ω—ã–π PDF: ${pdf.title} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from.id}`);
      
    } catch (error) {
      console.error(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF –ø–æ URL: ${error.message}`);
      
      // Fallback - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫—É
      await ctx.reply(message + `\n\nüì• [–°–∫–∞—á–∞—Ç—å PDF](${pdf.url})`, {
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard([
          [Markup.button.url('üì• –û—Ç–∫—Ä—ã—Ç—å PDF', pdf.url)],
          [Markup.button.url('üìû –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')]
        ])
      });
      
      console.log(`‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ PDF: ${pdf.title}`);
    }
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω –Ω–∞ 3 –¥–Ω—è
   */
  generate3DayPlan(technique, isChildFlow, segment) {
    if (isChildFlow) {
      return {
        day1: {
          title: '–î–µ–Ω—å 1: –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Ç–µ—Ö–Ω–∏–∫–æ–π',
          tasks: [
            '–ü–æ–∫–∞–∂–∏—Ç–µ —Ä–µ–±–µ–Ω–∫—É —Ç–µ—Ö–Ω–∏–∫—É –≤ –∏–≥—Ä–æ–≤–æ–π —Ñ–æ—Ä–º–µ',
            '–°–¥–µ–ª–∞–π—Ç–µ 1 —Ä–∞–∑ –≤–º–µ—Å—Ç–µ, –Ω–µ –Ω–∞—Å—Ç–∞–∏–≤–∞–π—Ç–µ',
            '–ü–æ—Ö–≤–∞–ª–∏—Ç–µ –∑–∞ –ª—é–±–æ–µ —É—á–∞—Å—Ç–∏–µ'
          ],
          goal: '–†–µ–±–µ–Ω–æ–∫ –ø–æ–Ω—è–ª, —á—Ç–æ —ç—Ç–æ –∏–≥—Ä–∞'
        },
        day2: {
          title: '–î–µ–Ω—å 2: –ü—Ä–∏–≤—ã–∫–∞–Ω–∏–µ',
          tasks: [
            '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É 2-3 —Ä–∞–∑–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è',
            '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏ –∫–∞–ø—Ä–∏–∑–∞—Ö –∏–ª–∏ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º',
            '–î–æ–±–∞–≤—å—Ç–µ –∑–≤—É–∫–∏ –∏–ª–∏ –¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è –∏–Ω—Ç–µ—Ä–µ—Å–∞'
          ],
          goal: '–†–µ–±–µ–Ω–æ–∫ –ø–æ–º–Ω–∏—Ç —Ç–µ—Ö–Ω–∏–∫—É'
        },
        day3: {
          title: '–î–µ–Ω—å 3: –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ',
          tasks: [
            '–†–µ–±–µ–Ω–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏–∫—É —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ',
            '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö',
            '–û—Ç–º–µ—Ç—å—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏'
          ],
          goal: '–¢–µ—Ö–Ω–∏–∫–∞ —Å—Ç–∞–ª–∞ –ø—Ä–∏–≤—ã—á–∫–æ–π'
        }
      };
    } else {
      if (segment === 'HOT_LEAD') {
        return {
          day1: {
            title: '–î–µ–Ω—å 1: –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å',
            tasks: [
              '–û—Å–≤–æ–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å',
              '–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—Ä–∏—Å—Ç—É–ø–µ —Å—Ç—Ä–µ—Å—Å–∞/–ø–∞–Ω–∏–∫–∏',
              '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ 5-6 —Ä–∞–∑ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è'
            ],
            goal: '–¢–µ—Ö–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏'
          },
          day2: {
            title: '–î–µ–Ω—å 2: –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞',
            tasks: [
              '–î–µ–ª–∞–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –∫–∞–∂–¥—ã–µ 2-3 —á–∞—Å–∞',
              '–ù–µ –∂–¥–∏—Ç–µ —Å—Ç—Ä–µ—Å—Å–∞ - –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ',
              '–û—Ç–º–µ—Ç—å—Ç–µ —Å–Ω–∏–∂–µ–Ω–∏–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤'
            ],
            goal: '–ü—Ä–∏—Å—Ç—É–ø—ã —Å—Ç–∞–ª–∏ —Ä–µ–∂–µ –∏ —Å–ª–∞–±–µ–µ'
          },
          day3: {
            title: '–î–µ–Ω—å 3: –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ',
            tasks: [
              '–¢–µ—Ö–Ω–∏–∫–∞ —Å—Ç–∞–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π',
              '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏ –ø–µ—Ä–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è',
              '–û—Ü–µ–Ω–∏—Ç–µ –æ–±—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è'
            ],
            goal: '–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–∏—Ç—É–∞—Ü–∏–µ–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
          }
        };
      } else {
        return {
          day1: {
            title: '–î–µ–Ω—å 1: –û—Å–≤–æ–µ–Ω–∏–µ',
            tasks: [
              '–ò–∑—É—á–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É, –ø–æ—Ç—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å 3-4 —Ä–∞–∑–∞',
              '–ù–∞–π–¥–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –º–µ—Å—Ç–æ –∏ –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏',
              '–û—Ç–º–µ—Ç—å—Ç–µ –ø–µ—Ä–≤—ã–µ –æ—â—É—â–µ–Ω–∏—è'
            ],
            goal: '–¢–µ—Ö–Ω–∏–∫–∞ –ø–æ–Ω—è—Ç–Ω–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏–º–∞'
          },
          day2: {
            title: '–î–µ–Ω—å 2: –†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å',
            tasks: [
              '–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è',
              '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö',
              '–ó–∞–º–µ—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–∏'
            ],
            goal: '–¢–µ—Ö–Ω–∏–∫–∞ –≤—Ö–æ–¥–∏—Ç –≤ –ø—Ä–∏–≤—ã—á–∫—É'
          },
          day3: {
            title: '–î–µ–Ω—å 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è',
            tasks: [
              '–ü—Ä–∏–º–µ–Ω—è–π—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É –≤ —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö',
              '–ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ —Å–≤–æ–π —Ä–∏—Ç–º –∂–∏–∑–Ω–∏',
              '–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –¥–∞–ª—å–Ω–µ–π—à—É—é –ø—Ä–∞–∫—Ç–∏–∫—É'
            ],
            goal: '–¢–µ—Ö–Ω–∏–∫–∞ —Å—Ç–∞–ª–∞ —á–∞—Å—Ç—å—é –∂–∏–∑–Ω–∏'
          }
        };
      }
    }
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –±–æ–Ω—É—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   */
  getBonusForUser(analysisResult, surveyData) {
    const title = this.generatePersonalizedTitle(analysisResult, surveyData);
    const subtitle = this.generatePersonalizedSubtitle(analysisResult, surveyData);
    const technique = this.getMasterTechnique(analysisResult, surveyData);
    
    return {
      id: `personalized_${analysisResult.primaryIssue || 'general'}_${analysisResult.segment}`,
      title: title,
      subtitle: subtitle,
      description: `–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã: ${technique.problem}`,
      technique: technique,
      target_segments: [analysisResult.segment],
      approach: 'minimalist',
      primary_issue: analysisResult.primaryIssue,
      is_child: analysisResult.analysisType === 'child'
    };
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–æ–Ω—É—Å–µ
   */
  generateBonusMessage(bonus, analysisResult) {
    const segment = analysisResult.segment;
    const isHotLead = segment === 'HOT_LEAD';
    const isChildFlow = analysisResult.analysisType === 'child';
    const technique = bonus.technique;
    
    let message = `üéÅ *–í–ê–®–ê –ü–ï–†–°–û–ù–ê–õ–¨–ù–ê–Ø –¢–ï–•–ù–ò–ö–ê –ì–û–¢–û–í–ê!*\n\n`;
    
    message += `${bonus.title}\n`;
    message += `${bonus.subtitle}\n\n`;
    
    message += `üéØ *–í–∞—à–∞ –ø—Ä–æ–±–ª–µ–º–∞:* ${technique.problem}\n`;
    message += `‚ú® *–†–µ—à–µ–Ω–∏–µ:* ${technique.name}\n`;
    message += `‚è±Ô∏è *–í—Ä–µ–º—è:* ${technique.duration}\n`;
    message += `üéâ *–†–µ–∑—É–ª—å—Ç–∞—Ç:* ${technique.result}\n\n`;
    
    message += `üìñ *–í –≤–∞—à–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–º –≥–∏–¥–µ:*\n`;
    if (isChildFlow) {
      message += `‚Ä¢ üéÆ –ò–≥—Ä–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞\n`;
      message += `‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π\n`;
      message += `‚Ä¢ üìÖ –ü–ª–∞–Ω –æ—Å–≤–æ–µ–Ω–∏—è –Ω–∞ 3 –¥–Ω—è\n`;
      message += `‚Ä¢ üí° –°–æ–≤–µ—Ç—ã –ø–æ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ —Ä–µ–±–µ–Ω–∫–∞\n\n`;
    } else {
      message += `‚Ä¢ üå¨Ô∏è –û–¥–Ω–∞ –º–æ—â–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ —Å –ø–æ—à–∞–≥–æ–≤–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π\n`;
      message += `‚Ä¢ üß† –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏\n`;
      message += `‚Ä¢ üìÖ –ü–ª–∞–Ω –æ—Å–≤–æ–µ–Ω–∏—è –Ω–∞ 3 –¥–Ω—è\n`;
      message += `‚Ä¢ üéØ –ß–µ—Ç–∫–∏–µ –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n`;
    }
    
    if (isHotLead) {
      message += `‚ö° *–°–†–û–ß–ù–ê–Ø –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø:*\n`;
      message += `–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã. `;
      message += `–≠—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∞ –ø–æ–º–æ–∂–µ—Ç —É–∂–µ —á–µ—Ä–µ–∑ 2-3 –º–∏–Ω—É—Ç—ã!\n\n`;
      message += `üö® *–ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!*\n\n`;
    } else {
      message += `üí´ *–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∞:*\n`;
      message += `–ü–æ–¥–æ–±—Ä–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø–æ–¥ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å –∏ –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É. `;
      message += `–ü—Ä–æ—Å—Ç–∞—è, –Ω–æ –æ—á–µ–Ω—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è!\n\n`;
    }
    
    message += `üìû *–•–û–¢–ò–¢–ï –ë–û–õ–¨–®–ï –¢–ï–•–ù–ò–ö?*\n`;
    message += `–†–∞–Ω–µ–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ –¥–µ—Ç–µ–π —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –Ω–∏–∂–µ.\n\n`;
    message += `–ù–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ–ª—É—á–∏—Ç–µ:\n`;
    message += `‚Ä¢ –ü–æ–ª–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ–¥ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é\n`;
    message += `‚Ä¢ –ü–ª–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π\n`;
    message += `‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n`;
    message += `‚Ä¢ –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã\n\n`;
    message += `üë©‚Äç‚öïÔ∏è *–ó–∞–ø–∏—Å–∞—Ç—å—Å—è:* @NastuPopova`;
    
    return message;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –±–æ–Ω—É—Å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
   */
  generateBonusKeyboard(bonus, deliveryMethod) {
    const keyboard = [
      [Markup.button.callback('üìû –•–æ—á—É –±–æ–ª—å—à–µ —Ç–µ—Ö–Ω–∏–∫!', 'contact_request')],
      [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')],
      [Markup.button.callback('üéÅ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', 'more_materials')]
    ];

    // –ï—Å–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª –∏ —Å–µ–≥–º–µ–Ω—Ç –Ω–µ HOT_LEAD, –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    if (deliveryMethod === 'file' && bonus.target_segments[0] !== 'HOT_LEAD') {
      keyboard.unshift([
        Markup.button.callback('üì• –ü–æ–ª—É—á–∏—Ç—å –≥–∏–¥', `download_${bonus.id}`)
      ]);
    }

    return Markup.inlineKeyboard(keyboard);
  }

  /**
   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTML-—Ñ–∞–π–ª (–Ω–∞–∑—ã–≤–∞–µ–º—ã–π PDF –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –±–æ—Ç–∞)
   */
  async sendPDFFile(ctx, bonus) {
    try {
      console.log(`üìù –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –≥–∏–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${ctx.from.id}`);
      
      const filePath = await this.generatePersonalizedHTML(
        ctx.from.id,
        ctx.session.analysisResult,
        ctx.session.answers
      );

      console.log(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π —Ñ–∞–π–ª: ${filePath}`);

      const isChildFlow = ctx.session.analysisResult.analysisType === 'child';
      const isHotLead = ctx.session.analysisResult.segment === 'HOT_LEAD';
      const technique = bonus.technique;

      let caption = `üéÅ *${bonus.title}*\n\n`;
      
      if (isChildFlow) {
        caption += `üß∏ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è —Ç–µ—Ö–Ω–∏–∫–∞ –¥–ª—è –≤–∞—à–µ–≥–æ —Ä–µ–±–µ–Ω–∫–∞!\n\n`;
      } else {
        caption += `üå¨Ô∏è –í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è —Ç–µ—Ö–Ω–∏–∫–∞!\n\n`;
      }
      
      caption += `‚ú® *–í —Ñ–∞–π–ª–µ:*\n`;
      caption += `‚Ä¢ ${technique.name}\n`;
      caption += `‚Ä¢ –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è\n`;
      caption += `‚Ä¢ –ü–ª–∞–Ω –æ—Å–≤–æ–µ–Ω–∏—è –Ω–∞ 3 –¥–Ω—è\n`;
      caption += `‚Ä¢ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã\n\n`;
      
      if (isHotLead) {
        caption += `‚ö° *–í–ê–ñ–ù–û:* –ù–∞—á–Ω–∏—Ç–µ —Å —Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!\n\n`;
      }
      
      caption += `üì± –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n`;
      caption += `üìû –ë–æ–ª—å—à–µ —Ç–µ—Ö–Ω–∏–∫ —É @NastuPopova`;

      await ctx.replyWithDocument(
        { source: filePath },
        {
          caption: caption,
          parse_mode: 'Markdown',
          ...Markup.inlineKeyboard([
            [Markup.button.callback('üìû –•–æ—á—É –±–æ–ª—å—à–µ —Ç–µ—Ö–Ω–∏–∫!', 'contact_request')],
            [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')],
            [Markup.button.callback('üéÅ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã', 'more_materials')]
          ])
        }
      );
      
      console.log(`‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –≥–∏–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${bonus.title}`);
      
      setTimeout(() => {
        try {
          if (fs.existsSync(filePath)) {
            fs.unlinkSync(filePath);
            console.log(`üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: ${filePath}`);
          }
        } catch (cleanupError) {
          console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:', cleanupError);
        }
      }, 1000);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –≥–∏–¥–∞:', error.message);
      
      const technique = bonus.technique;
      let fallbackMessage = `‚ö†Ô∏è –§–∞–π–ª –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –≤–æ—Ç –≤–∞—à–∞ —Ç–µ—Ö–Ω–∏–∫–∞:\n\n`;
      fallbackMessage += `üéØ *${technique.name}*\n\n`;
      fallbackMessage += `*–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*\n`;
      technique.steps.forEach((step, index) => {
        fallbackMessage += `${index + 1}. ${step}\n`;
      });
      fallbackMessage += `\n‚è±Ô∏è *–í—Ä–µ–º—è:* ${technique.duration}\n`;
      fallbackMessage += `‚ú® *–†–µ–∑—É–ª—å—Ç–∞—Ç:* ${technique.result}\n\n`;
      fallbackMessage += `üí¨ –ù–∞–ø–∏—à–∏—Ç–µ @NastuPopova –∑–∞ –ø–æ–ª–Ω—ã–º –≥–∏–¥–æ–º –∏ –ø–ª–∞–Ω–æ–º –Ω–∞ 3 –¥–Ω—è!`;
      
      await ctx.reply(fallbackMessage, {
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard([
          [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')],
          [Markup.button.callback('üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é', 'contact_request')]
        ])
      });
    }
  }

  /**
   * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
   */
  async showMoreMaterials(ctx) {
    const isChildFlow = ctx.session?.analysisResult?.analysisType === 'child';
    const primaryIssue = ctx.session?.analysisResult?.primaryIssue;
    const translatedIssue = this.translateValue(primaryIssue);
    
    let message = `üéÅ *–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–†–ò–ê–õ–´*\n\n`;
    
    message += `üí° *–í—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π HTML-–≥–∏–¥!*\n`;
    message += `–≠—Ç–æ —Ç–æ–ª—å–∫–æ 1 –∏–∑ 15+ —Ç–µ—Ö–Ω–∏–∫ –≤ –∞–≤—Ç–æ—Ä—Å–∫–æ–π —Å–∏—Å—Ç–µ–º–µ. –†–∞–Ω–µ–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö –∏ –¥–µ—Ç–µ–π —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –∑–¥–µ—Å—å.\n\n`;
    
    // –ë–ï–°–ü–õ–ê–¢–ù–´–ï –ë–û–ù–£–°–´
    message += `üéÅ *–ë–ï–°–ü–õ–ê–¢–ù–´–ï –ë–û–ù–£–°–´:*\n`;
    
    if (isChildFlow) {
      message += `‚Ä¢ üì± –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π HTML-–≥–∏–¥ (—É–∂–µ –ø–æ–ª—É—á–∏–ª–∏)\n`;
      message += `‚Ä¢ üìÑ PDF "–î—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –∏–≥—Ä—ã –¥–ª—è –¥–µ—Ç–µ–π" (—Ä–∞–Ω–µ–µ –¥–µ—Ç—Å–∫–∏–π –±–æ–Ω—É—Å)\n`;
      message += `‚Ä¢ üé• –í–∏–¥–µ–æ "–ö–∞–∫ –Ω–∞—É—á–∏—Ç—å —Ä–µ–±–µ–Ω–∫–∞ –¥—ã—à–∞—Ç—å" (3 –º–∏–Ω)\n`;
      message += `‚Ä¢ üìù –ß–µ–∫-–ª–∏—Å—Ç "–ü—Ä–∏–∑–Ω–∞–∫–∏ —Å—Ç—Ä–µ—Å—Å–∞ —É –¥–µ—Ç–µ–π"\n\n`;
    } else {
      message += `‚Ä¢ üì± –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π HTML-–≥–∏–¥ (—É–∂–µ –ø–æ–ª—É—á–∏–ª–∏)\n`;
      message += `‚Ä¢ üìÑ PDF "–ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å –¥—ã—Ö–∞–Ω–∏–µ" (—Ä–∞–Ω–µ–µ –≤–∑—Ä–æ—Å–ª—ã–π –±–æ–Ω—É—Å)\n`;
      message += `‚Ä¢ üé• –í–∏–¥–µ–æ "3 —Ç–µ—Ö–Ω–∏–∫–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å" (5 –º–∏–Ω)\n`;
      message += `‚Ä¢ üìù –ß–µ–∫-–ª–∏—Å—Ç "–°–∞–º–æ–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥—ã—Ö–∞–Ω–∏—è"\n\n`;
    }
    
    // –ü–õ–ê–¢–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê
    if (isChildFlow) {
      message += `üë∂ *–ü–û–õ–ù–ê–Ø –î–ï–¢–°–ö–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê (–æ—Ç 3500‚ÇΩ):*\n`;
      message += `‚Ä¢ üéÆ 15 –∏–≥—Ä–æ–≤—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π\n`;
      message += `‚Ä¢ üò¥ 5 —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –¥–ª—è —Å–Ω–∞\n`;
      message += `‚Ä¢ üéØ –¢–µ—Ö–Ω–∏–∫–∏ –¥–ª—è –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏ –≤ —É—á–µ–±–µ\n`;
      message += `‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω—ã–µ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏\n`;
      message += `‚Ä¢ üì± –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏\n`;
      message += `‚Ä¢ üé• 12 –≤–∏–¥–µ–æ—É—Ä–æ–∫–æ–≤ —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π\n`;
      message += `‚Ä¢ üìû 3 –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–µ—Ç—Å–∫–æ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞\n`;
      message += `‚Ä¢ üìä –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n\n`;
    } else {
      message += `üßò *–ü–û–õ–ù–ê–Ø –ü–†–û–ì–†–ê–ú–ú–ê "${translatedIssue.toUpperCase()}" (–æ—Ç 3500‚ÇΩ):*\n`;
      message += `‚Ä¢ üö® 5 —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ (2-5 –º–∏–Ω)\n`;
      message += `‚Ä¢ üìÖ 7 –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –ø—Ä–∞–∫—Ç–∏–∫ (5-20 –º–∏–Ω)\n`;
      message += `‚Ä¢ üéØ 5 —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –ø–æ–¥ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É\n`;
      message += `‚Ä¢ üîß –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫ –¥—ã—Ö–∞–Ω–∏—è\n`;
      message += `‚Ä¢ üìä –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n`;
      message += `‚Ä¢ üé• 20 –≤–∏–¥–µ–æ—É—Ä–æ–∫–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π\n`;
      message += `‚Ä¢ üìû 5 –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π —Å —ç–∫—Å–ø–µ—Ä—Ç–æ–º\n`;
      message += `‚Ä¢ üì± –î–æ—Å—Ç—É–ø –∫ –∑–∞–∫—Ä—ã—Ç–æ–º—É —Å–æ–æ–±—â–µ—Å—Ç–≤—É\n\n`;
    }
    
    // –†–ï–ó–£–õ–¨–¢–ê–¢–´
    message += `üìà *–†–ï–ó–£–õ–¨–¢–ê–¢ –ß–ï–†–ï–ó 30 –î–ù–ï–ô:*\n`;
    message += `‚Ä¢ –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ —Å–≤–æ–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º\n`;
    message += `‚Ä¢ –ù–∞–≤—ã–∫–∏ –±—ã—Å—Ç—Ä–æ–π —Å–∞–º–æ–ø–æ–º–æ—â–∏ –≤ –ª—é–±–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏\n`;
    message += `‚Ä¢ –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∂–∏–∑–Ω–∏\n`;
    message += `‚Ä¢ –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª–µ–∫–∞—Ä—Å—Ç–≤\n\n`;
    
    // –ê–ö–¶–ò–Ø
    message += `üî• *–ê–ö–¶–ò–Ø –°–ï–ì–û–î–ù–Ø:*\n`;
    message += `üíù –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: –ë–ï–°–ü–õ–ê–¢–ù–û (–æ–±—ã—á–Ω–æ 2000‚ÇΩ)\n`;
    message += `üì¶ –ü—Ä–æ–≥—Ä–∞–º–º–∞: —Å–∫–∏–¥–∫–∞ 30% –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ —Å–µ–≥–æ–¥–Ω—è\n`;
    message += `üéÅ –í—Å–µ –±–æ–Ω—É—Å—ã: –≤ –ø–æ–¥–∞—Ä–æ–∫ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n\n`;
    
    message += `üë©‚Äç‚öïÔ∏è *–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –ê–Ω–∞—Å—Ç–∞—Å–∏–∏:* @NastuPopova`;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –±–æ–Ω—É—Å–∞–º–∏
    const keyboard = [];
    
    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    keyboard.push([
      Markup.button.callback('üî• –•–æ—á—É –ø–æ–ª–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É!', 'contact_request')
    ]);
    
    // –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –±–æ–Ω—É—Å—ã
    if (isChildFlow) {
      keyboard.push([
        Markup.button.callback('üìÑ PDF: –ò–≥—Ä—ã –¥–ª—è –¥–µ—Ç–µ–π', 'download_pdf_child_games')
      ]);
    } else {
      keyboard.push([
        Markup.button.callback('üìÑ PDF: –ê–Ω—Ç–∏—Å—Ç—Ä–µ—Å—Å', 'download_pdf_adult_antistress')
      ]);
    }
    
    // –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞ - –∫–æ–Ω—Ç–∞–∫—Ç—ã
    keyboard.push([
      Markup.button.url('üí¨ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é', 'https://t.me/NastuPopova')
    ]);
    
    // –ß–µ—Ç–≤–µ—Ä—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ - –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    keyboard.push([
      Markup.button.callback('üîô –ö –º–æ–µ–π —Ç–µ—Ö–Ω–∏–∫–µ', 'back_to_results')
    ]);

    await ctx.editMessageText(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard(keyboard)
    });
  }

  /**
   * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
   */
  translateValue(value) {
    return config.TRANSLATIONS[value] || value;
  }

  translateArray(values) {
    if (!values || !Array.isArray(values)) return [];
    return values.map(value => this.translateValue(value));
  }

  getStressDescription(level) {
    if (level >= 8) return '–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤—ã—Å–æ–∫–∏–π';
    if (level >= 6) return '–≤—ã—Å–æ–∫–∏–π';
    if (level >= 4) return '—É–º–µ—Ä–µ–Ω–Ω—ã–π';
    return '–Ω–∏–∑–∫–∏–π';
  }

  /**
   * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏ –±–æ–Ω—É—Å–æ–≤
   */
  logBonusDelivery(userId, bonusId, deliveryMethod, segment, primaryIssue) {
    const logEntry = {
      user_id: userId,
      bonus_id: bonusId,
      delivery_method: deliveryMethod,
      segment: segment,
      primary_issue: primaryIssue,
      approach: 'minimalist',
      technique_count: 1,
      timestamp: new Date().toISOString()
    };
    this.deliveryLog.push(logEntry);
    console.log(`üìä –õ–æ–≥ –¥–æ—Å—Ç–∞–≤–∫–∏ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –±–æ–Ω—É—Å–∞:`, logEntry);
  }

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   */
  getBonusStats() {
    const minimalistCount = this.deliveryLog.filter(log => log.approach === 'minimalist').length;
    const issueBreakdown = {};
    
    this.deliveryLog.forEach(log => {
      if (log.primary_issue) {
        issueBreakdown[log.primary_issue] = (issueBreakdown[log.primary_issue] || 0) + 1;
      }
    });
    
    return {
      ...this.stats,
      delivery_count: this.deliveryLog.length,
      minimalist_count: minimalistCount,
      issue_breakdown: issueBreakdown,
      approach: 'minimalist',
      conversion_focus: 'single_technique_mastery'
    };
  }

  /**
   * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
   */
  async handleDownloadRequest(ctx, bonusId) {
    try {
      console.log(`üì• –ó–∞–ø—Ä–æ—Å –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≥–∏–¥–∞: ${bonusId}`);
      
      if (!ctx.session?.analysisResult) {
        await ctx.answerCbQuery('‚ö†Ô∏è –ü—Ä–æ–π–¥–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –∑–∞–Ω–æ–≤–æ', { show_alert: true });
        return;
      }

      const bonus = this.getBonusForUser(
        ctx.session.analysisResult,
        ctx.session.answers
      );

      await ctx.answerCbQuery('üì• –ì–æ—Ç–æ–≤–ª—é –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥...');
      await this.sendPDFFile(ctx, bonus);
      
      this.logBonusDelivery(
        ctx.from.id,
        bonus.id,
        'file',
        ctx.session.analysisResult.segment,
        ctx.session.analysisResult.primaryIssue
      );
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ handleDownloadRequest:', error);
      await ctx.answerCbQuery('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', { show_alert: true });
    }
  }
}

module.exports = PDFBonusManager;
