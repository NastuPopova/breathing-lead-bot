// –§–∞–π–ª: core/handlers.js - –ü–û–õ–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø (—Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ PDF –∏ –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏)

const { Markup } = require('telegraf');
const config = require('../config');

class Handlers {
  constructor(botInstance) {
    this.bot = botInstance;
    this.telegramBot = botInstance.bot;
    
    this.surveyQuestions = botInstance.surveyQuestions;
    this.verseAnalysis = botInstance.verseAnalysis;
    this.leadTransfer = botInstance.leadTransfer;
    this.pdfManager = botInstance.pdfManager;
    this.adminNotifications = botInstance.adminNotifications;
    
    this.validateDependencies();
  }

  validateDependencies() {
    console.log('Handlers: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...');
    const checks = {
      pdfManager: !!this.pdfManager,
      'pdfManager.getBonusForUser': !!this.pdfManager?.getBonusForUser,
      'pdfManager.fileHandler': !!this.pdfManager?.fileHandler,
      surveyQuestions: !!this.surveyQuestions,
      verseAnalysis: !!this.verseAnalysis
    };
    
    Object.entries(checks).forEach(([check, result]) => {
      console.log(`${result ? '‚úÖ' : '‚ùå'} ${check}: ${result}`);
    });
  }

  setup() {
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–±—ã—Ç–∏–π...');
    this.setupUserCommands();
    this.setupUserCallbacks();
    this.setupTextHandlers();
    console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
  }

  setupUserCommands() {
    this.telegramBot.start(async (ctx) => {
      try { await this.handleStart(ctx); } catch (e) { await this.handleError(ctx, e); }
    });

    this.telegramBot.help(async (ctx) => {
      try { await this.handleHelp(ctx); } catch (e) { await this.handleError(ctx, e); }
    });

    this.telegramBot.command('restart', async (ctx) => {
      try { await this.handleRestart(ctx); } catch (e) { await this.handleError(ctx, e); }
    });
  }

  setupTextHandlers() {
    this.telegramBot.on('text', async (ctx) => {
      if (!ctx.session?.inSurvey) {
        return await ctx.reply('–ù–∞–ø–∏—à–∏—Ç–µ /start, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É');
      }
      await ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ üòä');
    });
  }

  setupUserCallbacks() {
    this.telegramBot.on('callback_query', async (ctx) => {
      const callbackData = ctx.callbackQuery.data;
      console.log(`\n${'='.repeat(50)}`);
      console.log(`üîî User Callback: "${callbackData}" –æ—Ç ${ctx.from.id}`);
      console.log(`üìã –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –≤ —Å–µ—Å—Å–∏–∏: ${ctx.session?.currentQuestion}`);
      console.log(`${'='.repeat(50)}\n`);

      await ctx.answerCbQuery().catch(() => {});

      // === –ù–û–í–´–ï –ö–ù–û–ü–ö–ò –ü–û–°–õ–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ===
      if (callbackData === 'get_bonus') {
        console.log('üéÅ –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞: –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É');
        await ctx.answerCbQuery('üß† –ì–æ—Ç–æ–≤–ª—é –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥...');

        try {
          const analysisResult = ctx.session?.analysisResult;
          const surveyAnswers = ctx.session?.answers || {};

          if (!analysisResult || !surveyAnswers) {
            await ctx.reply('üòî –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–π–¥–∏—Ç–µ –∞–Ω–∫–µ—Ç—É –∑–∞–Ω–æ–≤–æ: /start');
            return;
          }

          const bonus = this.pdfManager.getBonusForUser(analysisResult, surveyAnswers);
          console.log(`‚úÖ –ë–æ–Ω—É—Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${bonus.technique.name} (${bonus.segment})`);

          await this.pdfManager.fileHandler.sendPersonalizedBonus(ctx, bonus);
          await this.pdfManager.fileHandler.showPostPDFMenu(ctx);

        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–æ–Ω—É—Å–∞:', error);
          await ctx.reply('üòî –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥–∏–¥–∞. –ù–∞–ø–∏—à–∏—Ç–µ @NastuPopova');
        }
        return;
      }

      if (callbackData === 'contact_request') {
        console.log('üìû –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞: –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é');
        await ctx.answerCbQuery();

        const message = config.MESSAGES?.CONTACT_TRAINER || 
          `üìû *–ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é*\n\n` +
          `–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã:\n\n` +
          `üë©‚Äç‚öïÔ∏è –ê–Ω–∞—Å—Ç–∞—Å–∏—è –ü–æ–ø–æ–≤–∞: @NastuPopova\n` +
          `ü§ñ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç: ${config.MAIN_BOT_URL || '@breathing_opros_bot'}\n\n` +
          `–ù–∞–ø–∏—à–∏—Ç–µ –µ–π ‚Äî –æ–Ω–∞ –∂–¥—ë—Ç –≤–∞—Å!`;

        await ctx.reply(message, {
          parse_mode: 'Markdown',
          ...Markup.inlineKeyboard([
            [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')],
            [Markup.button.url('ü§ñ –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç', config.MAIN_BOT_URL || 'https://t.me/breathing_opros_bot')],
            [Markup.button.callback('üîô –ù–∞–∑–∞–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º', 'back_to_results')]
          ])
        });
        return;
      }

      if (callbackData === 'back_to_results') {
        await ctx.answerCbQuery();
        if (ctx.session?.analysisResult) {
          await this.showResults(ctx, ctx.session.analysisResult);
        } else {
          await ctx.reply('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–π–¥–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: /start');
        }
        return;
      }

      // –ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ "–ü–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"
      if (callbackData === 'help_choose_program') {
        return await this.handleProgramHelp(ctx);
      }

      // –ê–¥–º–∏–Ω–∫–∞
      if (callbackData.startsWith('admin_')) {
        return;
      }

      // –ê–Ω–∫–µ—Ç–∞: –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
      if (callbackData === 'start_survey' || callbackData === 'start_survey_from_about') {
        console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: start_survey');
        return await this.startSurvey(ctx);
      }
      if (callbackData === 'about_survey') {
        console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: about_survey');
        return await this.showAboutSurvey(ctx);
      }
      if (callbackData === 'back_to_main') {
        console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: back_to_main');
        return await this.backToMain(ctx);
      }

      // –û–¢–í–ï–¢–´ –ù–ê –í–û–ü–†–û–°–´ –ê–ù–ö–ï–¢–´
      const isSurveyAnswer = 
        callbackData.startsWith('age_') ||
        callbackData.startsWith('prob_') ||
        callbackData.startsWith('child_prob_') ||
        callbackData.startsWith('goal_') ||
        callbackData.startsWith('format_') ||
        callbackData.startsWith('stress_') ||
        callbackData.startsWith('sleep_') ||
        callbackData.startsWith('breath_') ||
        callbackData.startsWith('method_') ||
        callbackData.startsWith('freq_') ||
        callbackData.startsWith('shallow_') ||
        callbackData.startsWith('exp_') ||
        callbackData.startsWith('time_') ||
        callbackData.startsWith('prio_') ||
        callbackData.startsWith('med_') ||
        callbackData.startsWith('meds_') ||
        callbackData.startsWith('panic_') ||
        callbackData.startsWith('env_') ||
        callbackData.startsWith('nav_') ||
        callbackData === 'child_problems_done';

      if (isSurveyAnswer) {
        console.log('‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∫–∞–∫ –æ—Ç–≤–µ—Ç –Ω–∞ –∞–Ω–∫–µ—Ç—É');
        return await this.handleSurveyAnswer(ctx, callbackData);
      }

      console.log(`‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π callback: ${callbackData}`);
    });
  }

  // === –ú–ï–¢–û–î–´ –ê–ù–ö–ï–¢–´ (—Å–∫–æ–ø–∏—Ä—É–π –∏–∑ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è) ===
  async handleStart(ctx) {
    await ctx.reply(config.MESSAGES.WELCOME, { parse_mode: 'Markdown' });
  }

  async handleHelp(ctx) {
    await ctx.reply('–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.');
  }

  async handleRestart(ctx) {
    ctx.session = null;
    await ctx.reply('–°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞. –ù–∞–ø–∏—à–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞.');
  }

  async startSurvey(ctx) {
    ctx.session = ctx.session || {};
    ctx.session.inSurvey = true;
    ctx.session.answers = {};
    ctx.session.startTime = Date.now();
    ctx.session.currentQuestion = 'age_group';
    // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ (—Å–∫–æ–ø–∏—Ä—É–π –∏–∑ —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞)
    // await this.askCurrentQuestion(ctx);
  }

  async showAboutSurvey(ctx) {
    // –¢–≤–æ–π –∫–æ–¥ –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–Ω–∫–µ—Ç–µ
  }

  async backToMain(ctx) {
    // –¢–≤–æ–π –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  }

  async handleSurveyAnswer(ctx, callbackData) {
    // –í–°–Ø –õ–û–ì–ò–ö–ê –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤, –≤–∞–ª–∏–¥–∞—Ü–∏–∏, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
    // –∏ –≤—ã–∑–æ–≤–∞ completeSurvey –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
    // –≠—Ç–æ –±–æ–ª—å—à–æ–π –º–µ—Ç–æ–¥ –∏–∑ —Ç–≤–æ–µ–≥–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ ‚Äî –æ—Å—Ç–∞–≤—å –µ–≥–æ –∫–∞–∫ –µ—Å—Ç—å
  }

  async completeSurvey(ctx) {
    try {
      console.log('üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–Ω–∫–µ—Ç—ã');
      ctx.session.inSurvey = false;

      console.log('üß† –ó–∞–ø—É—Å–∫ VERSE-–∞–Ω–∞–ª–∏–∑–∞...');
      const analysisResult = this.verseAnalysis.analyzeUser(ctx.session.answers);
      console.log('‚úÖ VERSE-–∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω:', analysisResult.segment);

      ctx.session.analysisResult = analysisResult;
      ctx.session.completedAt = new Date().toISOString();

      await this.showResults(ctx, analysisResult);
      await this.transferLead(ctx, analysisResult);

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∫–µ—Ç—ã:', error);
      await ctx.reply('üòî –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @NastuPopova', { parse_mode: 'Markdown' });
    }
  }

  async showResults(ctx, analysisResult) {
    console.log('üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞');
    
    const message = analysisResult.personalMessage || '–í–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ—Ç–æ–≤—ã!';
    
    await ctx.reply(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard([
        [Markup.button.callback('üéÅ –ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ö–Ω–∏–∫—É', 'get_bonus')],
        [Markup.button.callback('üìû –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é', 'contact_request')],
        [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')]
      ])
    });
  }

  async transferLead(ctx, analysisResult) {
    try {
      const userData = {
        userInfo: {
          telegram_id: ctx.from.id,
          username: ctx.from.username,
          first_name: ctx.from.first_name,
          last_name: ctx.from.last_name
        },
        surveyAnswers: ctx.session.answers,
        analysisResult: analysisResult,
        surveyType: analysisResult.analysisType,
        completedAt: new Date().toISOString(),
        surveyDuration: Date.now() - ctx.session.startTime
      };

      await this.leadTransfer.processLead(userData);
      console.log('‚úÖ –õ–∏–¥ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω');

      if (this.bot.adminIntegration) {
        await this.bot.adminIntegration.notifySurveyResults(userData);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –ª–∏–¥–∞:', error);
    }
  }

  async handleProgramHelp(ctx) {
    console.log('ü§î handleProgramHelp');
    
    if (!this.pdfManager?.handleHelpChooseProgram) {
      return await this.showBuiltInProgramHelp(ctx);
    }

    try {
      await this.pdfManager.handleHelpChooseProgram(ctx);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ handleProgramHelp:', error);
      await this.showBuiltInProgramHelp(ctx);
    }
  }

  async showBuiltInProgramHelp(ctx) {
    const message = `ü§î *–ö–ê–ö –í–´–ë–†–ê–¢–¨ –ü–†–û–ì–†–ê–ú–ú–£?*\n\n` +
      `üõí **–°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ–º–ø–ª–µ–∫—Ç** ‚Äî –¥–ª—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è\n\n` +
      `üë®‚Äç‚öïÔ∏è **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è** ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥\n\n` +
      `üí¨ –î–ª—è —Ç–æ—á–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞–ø–∏—à–∏—Ç–µ @NastuPopova`;

    await ctx.reply(message, {
      parse_mode: 'Markdown',
      ...Markup.inlineKeyboard([
        [Markup.button.url('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ê–Ω–∞—Å—Ç–∞—Å–∏–∏', 'https://t.me/NastuPopova')]
      ])
    });
  }

  async handleError(ctx, error) {
    console.error('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏:', error);
    try {
      await ctx.reply('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ @NastuPopova');
    } catch {}
  }

  getStats() {
    return {
      name: 'MainHandlers',
      version: '7.3.0-FINAL-FIXED',
      features: ['personalized_pdf_bonus', 'contact_button', 'full_survey', 'all_handlers_restored'],
      last_updated: new Date().toISOString()
    };
  }
}

module.exports = Handlers;
